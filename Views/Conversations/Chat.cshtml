@model WhatsAppMvcComplete.Models.Conversation

@{
    ViewData["Title"] = $"Chat - {Model.PhoneNumber}";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="page-header">
    <h1><i class="bi bi-chat-dots text-success"></i> Chat with @Model.PhoneNumber</h1>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card chat-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>@Model.PhoneNumber</strong>
                <span id="chatStatus" class="badge bg-secondary">Connecting…</span>
            </div>

            <div id="chatMessages" class="card-body chat-messages" style="height:400px;overflow-y:auto;">
                @foreach (var message in Model.Messages.OrderBy(m => m.CreatedAt))
                {
                    <div class="message-container @(message.IsInbound ? "incoming" : "outgoing")">
                        <div class="message-bubble @(message.IsInbound ? "incoming" : "outgoing")">
                            <div>@message.MessageText</div>
                            <small>@message.CreatedAt.ToString("HH:mm")</small>
                        </div>
                    </div>
                }
            </div>

            <div class="card-footer">
                <form asp-action="SendReply" method="post" class="d-flex gap-2">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="conversationId" value="@Model.Id" />
                    <input type="hidden" name="phoneNumber" value="@Model.PhoneNumber" />
                    <input id="messageInput" name="messageText" class="form-control" required />
                    <button class="btn btn-success">Send</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        console.log("🔥 CHAT SCRIPT LOADED");

        const conversationId = @Model.Id;
        const chatMessages = document.getElementById("chatMessages");
        const chatStatus = document.getElementById("chatStatus");

        function addMessage(text, inbound, time) {
            const div = document.createElement("div");
            div.className = `message-container ${inbound ? "incoming" : "outgoing"}`;
            div.innerHTML = `
                <div class="message-bubble ${inbound ? "incoming" : "outgoing"}">
                    <div>${text}</div>
                    <small>${time}</small>
                </div>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function initChatSignalR() {
            if (!window.signalRConnection) {
                console.warn("⏳ SignalR not ready yet");
                return;
            }

            try {
                await signalRConnection.invoke("JoinConversation", conversationId);
                console.log("👥 Joined conversation", conversationId);

                chatStatus.className = "badge bg-success";
                chatStatus.textContent = "Live";

                signalRConnection.off("ReceiveMessage");
                signalRConnection.on("ReceiveMessage", data => {
                    console.log("📩 Message received", data);

                    if (data.conversationId === conversationId) {
                        addMessage(data.body, data.inbound, data.time);
                    }
                });

            } catch (err) {
                console.error("❌ JoinConversation failed", err);
                chatStatus.className = "badge bg-danger";
                chatStatus.textContent = "Error";
            }
        }

        // CASE 1: SignalR already connected
        if (window.signalRConnection?.state === "Connected") {
            console.log("⚡ SignalR already connected");
            initChatSignalR();
        }

        // CASE 2: SignalR connects later
        window.addEventListener("signalRReady", () => {
            console.log("🟢 signalRReady received");
            initChatSignalR();
        });
    </script>

<style>
    .chat-card {
        border-radius: 12px;
    }

    .chat-messages {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .message-container.incoming {
        justify-content: flex-start;
        display: flex;
    }

    .message-container.outgoing {
        justify-content: flex-end;
        display: flex;
    }

    .message-bubble {
        padding: 10px;
        border-radius: 10px;
        max-width: 70%;
    }

        .message-bubble.incoming {
            background: #f1f1f1;
        }

        .message-bubble.outgoing {
            background: #25D366;
            color: white;
        }
</style>
}