@using WhatsAppMvcComplete.Models
@model Conversation

<div class="container">
    <h5 class="mb-3">Chat with <strong>@Model.PhoneNumber</strong></h5>

    <!-- Messages container -->
    <div id="messages"
         class="border rounded p-3 mb-3"
         style="height:400px; overflow-y:auto; background-color:#f8f9fa;">
        @foreach (var m in Model.Messages.OrderBy(m => m.CreatedAt))
        {
            <div class="mb-2 text-@(m.IsInbound ? "start" : "end")">
                <span class="badge bg-@(m.IsInbound ? "secondary" : "success")">
                    @m.Body
                </span>
                <div>
                    <small class="text-muted">@m.CreatedAt.ToLocalTime().ToString("HH:mm")</small>
                </div>
            </div>
        }
    </div>

    <!-- Input -->
    <div class="input-group mb-3">
        <input id="messageInput" type="text"
               class="form-control"
               placeholder="Type a message..."
               autocomplete="off" />
        <button id="sendBtn" class="btn btn-success">Send</button>
    </div>
</div>

<!-- SignalR JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const conversationId = parseInt("@Model.Id");
        const messageInput = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendBtn");
        const container = document.getElementById("messages");

        // Send message to server
        function sendMessage() {
            const msg = messageInput.value.trim();
            if (!msg) return;

            fetch("/Conversations/Reply", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({
                    conversationId: conversationId,
                    message: msg
                })
            });

            messageInput.value = "";
        }

        sendBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize SignalR
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .configureLogging(signalR.LogLevel.Information)
            .withAutomaticReconnect()
            .build();

        connection.start()
            .then(() => {
                console.log("✅ SignalR connected");
                return connection.invoke("JoinConversation", conversationId);
            })
            .then(() => console.log("✅ Joined conversation group"))
            .catch(err => console.error("SignalR error:", err));

           connection.on("ReceiveMessage", msg => {
        console.log("Message received:", msg);

        const div = document.createElement("div");
        div.className = msg.inbound ? "text-start mb-2" : "text-end mb-2";
        div.innerHTML = `
            <span class="badge ${msg.inbound ? 'bg-secondary' : 'bg-success'}">
                ${msg.body}
            </span>
            <div>
                <small class="text-muted">${msg.time}</small>
            </div>
        `;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight; 
    });

       
        container.scrollTop = container.scrollHeight;
    });
</script>
